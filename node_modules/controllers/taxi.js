var db = require('controllers/database');
var mongoose = require('mongoose');
var taxicabs = mongoose.model('taxicabs');
var drivers = mongoose.model('drivers');
var method	= require('../../route/methods');

exports.getAllTaxi = function(callback){
  taxicabs.find({},function(err,doc){
		if (doc.length != 0) {
      callback({'res':true,'data':doc});
    } else {
      callback({'res':false});
    }
  });
}

exports.getTaxi = function(serial,callback){
  taxicabs.find({serial: serial},function(err,doc){
		if (doc.length != 0) {
      var keyVitual = method.keyVirtual();
      var key = method.key(keyVitual);
      var idTaxi = doc[0]._id;
      var mark = method.encode(doc[0].mark,key);
      var model = method.encode(doc[0].model,key);
      var serial = method.encode(doc[0].serial,key);
      var places = method.encode((doc[0].places).toString(),key);
      var luggages = method.encode((doc[0].luggages).toString(),key);
      var color = method.encode(doc[0].color,key);
      callback({'res':true,'key':keyVitual,'_id':idTaxi,'mark':mark,'model':model,'serial':serial,'places':places,
      'luggages':luggages,'color':color});
    }else{
      callback({'res':false});
    }
  });
}

exports.addTaxiToDriver = function(token,idTaxi,callback){
  taxicabs.find({_id:idTaxi},function(err,data){
		if(data.length != 0){
      var d = new Date();
      var m = d.getMonth() + 1;
      var month = (m<10) ? "0" + m : m;
      var date = d.getFullYear() + "/" + month + "/" + d.getDate() + " "
      + d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds();

      var model = data[0].model;
      var serial = data[0].serial;
      var places = data[0].places;
      var luggages = data[0].luggages;
      var color = data[0].color;
      drivers.find({_id:token,'taxis.serial':{$nin:serial}},function(err,dataDriver){
        if (err) {
          callback({'res':false,'response':"Error Taxi, you have the serial of taxi is not exist."});
        } else {
          if (dataDriver.length != 0) {
            if (dataDriver[0].taxis.length != 0) {
              drivers.update({_id:token,'taxis.working':true},{$set:{'taxis.$.working':false}},function(err){
                if(err){
                  callback({'res':false,'response':"Error Taxi, you have not added a new taxi."});
                }else{
                  drivers.update({_id:token},{$push:{taxis:{idTaxi:idTaxi,model:model,serial:serial,places:places,luggages:luggages,color:color,date:date,working:true}}},function(err){
                    if(err){
                      callback({'res':false,'response':"Error Taxi, you have not added a new taxi."});
                    }else{
                      callback({'res':true,'response':"Successfully Taxi, you have added a new taxi."});
                    }
                  });
                }
              });
            } else {
              drivers.update({_id:token},{$push:{taxis:{idTaxi:idTaxi,model:model,serial:serial,places:places,luggages:luggages,color:color,date:date,working:true}}},function(err){
                if(err){
                  callback({'res':false,'response':"Error Taxi, you have not added a new taxi."});
                }else{
                  callback({'res':true,'response':"Successfully Taxi, you have added a new taxi."});
                }
              });
            }
          } else {
            callback({'res':false,'response':"Error Taxi, you have the taxi."});
          }
        }
      });
    }else{
      callback({'res':false,'response':"Error 2"});
    }
  });
}
